name: DAAI Capstone - Master Weekly Autograding

on:
  push:
  workflow_dispatch:
    inputs:
      week:
        description: "Override week (1-7). Leave blank to use .github/week.txt"
        required: false
        default: ""

jobs:
  autograde:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Determine active week
        id: week
        shell: bash
        run: |
          if [ -n "${{ github.event.inputs.week }}" ]; then
            WEEK="${{ github.event.inputs.week }}"
          else
            WEEK="$(cat .github/week.txt | tr -d ' \n\r\t')"
          fi
          echo "WEEK=$WEEK" >> $GITHUB_ENV
          echo "Active week: $WEEK"

      # Common checks (run every week)
      - name: Check required base files
        shell: bash
        run: |
          test -f README.md
          test -f requirements.txt
          test -f notebooks/capstone.ipynb
          test -f data/Municipal_Service_Data.csv

      # Optional dependency install + notebook execution only when needed (Week 2+ typically)
      - name: Install dependencies
        if: env.WEEK != '1'
        run: pip install -r requirements.txt

      - name: Execute notebook (Week 2-5 recommended)
        if: env.WEEK == '2' || env.WEEK == '3' || env.WEEK == '4' || env.WEEK == '5'
        run: |
          pip install nbconvert
          jupyter nbconvert --to notebook --execute notebooks/capstone.ipynb --output executed.ipynb

      # Week 1
      - name: Week 1 - Proposal file exists + minimum commits
        if: env.WEEK == '1'
        shell: bash
        run: |
          test -f report/Proposal.pdf
          count=$(git rev-list --count HEAD)
          if [ $count -lt 2 ]; then
            echo "Need at least 2 commits for Week 1."
            exit 1
          fi

      # Week 2
      - name: Week 2 - Response_Time column exists
        if: env.WEEK == '2'
        run: |
          python - <<'PY'
          import pandas as pd
          df = pd.read_csv("data/Municipal_Service_Data.csv")
          assert "Response_Time" in df.columns, "Response_Time column missing in dataset"
          print("OK: Response_Time column found.")
          PY

      # Week 3
      - name: Week 3 - Feature engineering keywords present
        if: env.WEEK == '3'
        run: |
          python - <<'PY'
          import json
          with open("notebooks/capstone.ipynb","r",encoding="utf-8") as f:
              nb = json.load(f)
          content = str(nb).lower()
          # loose checks: students should show month/day-of-week features or similar time features
          assert ("month" in content) or ("day_of_week" in content) or ("weekday" in content), "Missing evidence of time features (month/weekday)"
          print("OK: Evidence of time features found.")
          PY

      # Week 4
      - name: Week 4 - KPI evidence present
        if: env.WEEK == '4'
        run: |
          python - <<'PY'
          import json
          with open("notebooks/capstone.ipynb","r",encoding="utf-8") as f:
              nb = json.load(f)
          content = str(nb)
          # Ask students to label KPI sections using 'KPI' text
          assert content.count("KPI") >= 4, "Not enough KPI labels found (need >= 4 occurrences of 'KPI')"
          print("OK: KPI evidence check passed.")
          PY

      # Week 5
      - name: Week 5 - Advanced insights evidence present
        if: env.WEEK == '5'
        run: |
          python - <<'PY'
          import json
          with open("notebooks/capstone.ipynb","r",encoding="utf-8") as f:
              nb = json.load(f)
          content = str(nb).lower()
          # Ask students to label insights using the word 'Insight'
          assert "insight" in content, "No 'Insight' section/label found in notebook"
          print("OK: Insight evidence check passed.")
          PY

      # Week 6
      - name: Week 6 - Dashboard link exists
        if: env.WEEK == '6'
        shell: bash
        run: |
          test -f dashboard/dashboard_link.txt
          # ensure non-empty
          if [ ! -s dashboard/dashboard_link.txt ]; then
            echo "dashboard_link.txt is empty. Paste your dashboard URL."
            exit 1
          fi

      # Week 7
      - name: Week 7 - Final report exists
        if: env.WEEK == '7'
        shell: bash
        run: |
          test -f report/Final_Report.pdf
          # basic non-empty file check
          if [ ! -s report/Final_Report.pdf ]; then
            echo "Final_Report.pdf is empty. Upload your PDF."
            exit 1
          fi
